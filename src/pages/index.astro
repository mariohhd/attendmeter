---
import Layout from '../layouts/Layout.astro'
import CoursesGrid from '../components/CoursesGrid.jsx'
import EOICoursesGrid from '../components/EOICoursesGrid.jsx'
import PassedClassesManager from '../components/PassedClassesManager.jsx'
import type { Course, EOICourse } from '../types/attendance'
import { 
  generateAcademicCalendar, 
  generateScheduledSessions, 
  SPANISH_HOLIDAYS_2025_2026 
} from '../utils/eoi-calendar'

// Sample EOI course for demonstration
const sampleEOICourse: EOICourse = {
  id: 'eoi_course_1',
  name: 'InglÃ©s B2.2',
  color: '#3b82f6',
  totalSessions: 60,
  target: 85,
  level: 'B2.2',
  language: 'InglÃ©s',
  teacherEmail: 'elena.garcia@educa.madrid.org',
  classroom: '201',
  schedule: {
    days: [1, 3], // Lunes y MiÃ©rcoles
    startTime: '18:40',
    endTime: '21:00'
  },
  academicCalendar: generateAcademicCalendar(
    new Date('2025-09-15'),
    new Date('2026-06-15'),
    [1, 3], // Lunes y MiÃ©rcoles
    SPANISH_HOLIDAYS_2025_2026
  ),
  sessions: [] // Se generarÃ¡n automÃ¡ticamente
}

// Generate sample sessions for the EOI course
const generateSessionId = () => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
sampleEOICourse.sessions = generateScheduledSessions(sampleEOICourse.academicCalendar, generateSessionId)

// Mark some sessions as attended for demo
sampleEOICourse.sessions.slice(0, 15).forEach((session, index) => {
  if (session.sessionType === 'regular' && index % 3 !== 0) {
    session.attended = true
  }
})

// Sample regular courses for demonstration
const sampleCourses: Course[] = [
  {
    id: 'course_1',
    name: 'Mathematics 101',
    color: '#10b981',
    totalSessions: 20,
    target: 85,
    sessions: [
      {
        id: 'session_1',
        date: new Date('2024-10-01'),
        attended: true,
        notes: 'Introduction to Calculus'
      },
      {
        id: 'session_2',
        date: new Date('2024-10-03'),
        attended: true
      },
      {
        id: 'session_3',
        date: new Date('2024-10-05'),
        attended: false,
        notes: 'Sick day'
      },
      {
        id: 'session_4',
        date: new Date('2024-10-08'),
        attended: true
      },
      {
        id: 'session_5',
        date: new Date('2024-10-10'),
        attended: true
      }
    ]
  }
]
---

<Layout title="AttendMeter - Controla tu Asistencia a Clases">
  <main class="app-container">
    <header class="app-header">
      <div class="header-content">
        <h1 class="app-title">
          <img src="/src/assets/attendmeter.png" alt="AttendMeter Logo" style="height: 48px; vertical-align: middle; margin-right: 1rem;" />
          AttendMeter
        </h1>
        <p class="app-subtitle">
          Controla tu asistencia a clases con indicadores visuales de progreso
          <br />
          <small>ðŸŽ“ Especializado para EOI - Cumple el requisito del 65% de asistencia</small>
        </p>
        
        <div class="header-actions">
          <button id="add-eoi-course-btn" class="primary-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            Crear Curso EOI
          </button>
          <button id="add-course-btn" class="secondary-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Curso General
          </button>
          <button id="export-btn" class="tertiary-btn">Exportar Datos</button>
        </div>
      </div>
    </header>

    <!-- Course Type Tabs -->
    <div class="course-tabs">
      <button class="tab-btn active" data-tab="eoi">
        ðŸŽ“ Cursos EOI
      </button>
      <button class="tab-btn" data-tab="general">
        ðŸ“š Cursos Generales
      </button>
    </div>

    <script>
      // Sample EOI course data injected from Astro
      const sampleEOICourse = /** @type {any} */ (JSON.parse(`{{JSON.stringify(sampleEOICourse)}}`));
      // Initialize EOI courses in localStorage with sample if empty
      try {
        const eoiCourses = localStorage.getItem('eoiCourses');
        if (!eoiCourses || JSON.parse(eoiCourses).length === 0) {
          localStorage.setItem('eoiCourses', JSON.stringify([sampleEOICourse]));
          localStorage.setItem(`eoi_sessions_${sampleEOICourse.id}`, JSON.stringify(sampleEOICourse.sessions));
        }
      } catch (e) { /* ignore */ }
    </script>
    <!-- EOI Courses Section (React Island) -->
    <div class="courses-container" id="eoi-courses-container">
      <div class="courses-grid eoi-grid">
        <EOICoursesGrid client:load sampleEOICourse={sampleEOICourse} />
      </div>
      <div class="empty-state eoi-empty" id="eoi-empty-state" style="display: none;">
        <div class="empty-icon">ðŸŽ“</div>
        <h3>No hay cursos EOI</h3>
        <p>Crea tu primer curso de la Escuela Oficial de Idiomas para comenzar a rastrear tu asistencia</p>
        <button class="primary-btn" onclick="document.getElementById('add-eoi-course-btn')?.click()">
          Crear Curso EOI
        </button>
      </div>
    </div>
  </main>
</Layout>

<style>
  /* Import global styles */
  @import '../styles/global.css';

  /* Course Type Tabs */
  .course-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    display: none;
  }

  .tab-btn {
    flex: 1;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    background: transparent;
    color: #64748b;
  }

  .tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .tab-btn:hover:not(.active) {
    background: #f1f5f9;
    color: #334155;
  }

  /* Enhanced header */
  .app-subtitle small {
    display: block;
    margin-top: 0.5rem;
    color: #059669;
    font-weight: 600;
  }

  /* Button variations */
  .tertiary-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    background: white;
    color: #6b7280;
  }

  .tertiary-btn:hover {
    border-color: #d1d5db;
    background: #f9fafb;
    color: #374151;
  }

  /* EOI specific styling */
  .eoi-grid {
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .eoi-empty {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px dashed #0ea5e9;
  }

  .eoi-empty .empty-icon {
    color: #0ea5e9;
  }

  /* Courses container */
  .courses-container {
    margin-bottom: 2rem;
  }

  .courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 2rem;
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .modal-close:hover {
    color: #374151;
  }

  .modal-form {
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .course-tabs {
      flex-direction: column;
    }
    
    .courses-grid {
      grid-template-columns: 1fr;
    }
    
    .header-actions {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-actions {
      flex-direction: column-reverse;
    }
  }

  /* Animation */
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .courses-container {
    animation: slideUp 0.5s ease-out;
  }
</style>
